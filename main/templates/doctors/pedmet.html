{% extends 'dbase.html' %}
{% load static %}

{% block title %}–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">üë®‚Äç‚öïÔ∏è –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ª–µ–∫–∞—Ä—Å—Ç–≤ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º</h2>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- –§–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ûï –ù–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.patient.id_for_label }}" class="form-label">–ü–∞—Ü–∏–µ–Ω—Ç:</label>
                                {{ form.patient }}
                                {% if form.patient.errors %}
                                    <div class="text-danger small">{{ form.patient.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.medicine.id_for_label }}" class="form-label">–õ–µ–∫–∞—Ä—Å—Ç–≤–æ:</label>
                                {{ form.medicine }}
                                {% if form.medicine.errors %}
                                    <div class="text-danger small">{{ form.medicine.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.quantity.id_for_label }}" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                    <div class="text-danger small">{{ form.quantity.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ</button>
                    <!-- O'zingizning URL ga moslashtiring -->
                    </form>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìã –°–ø–∏—Å–æ–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    {% if prescriptions %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ü–∞—Ü–∏–µ–Ω—Ç</th>
                                        <th>–õ–µ–∫–∞—Ä—Å—Ç–≤–æ</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th>–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <!-- ... oldingi kod (forma va jadval boshlanishi) ... -->
<tbody>
    {% for prescription in prescriptions %}
    <tr>
        <td>{{ prescription.id }}</td>
        <td>{{ prescription.patient }}</td>
        <td>{{ prescription.medicine }}</td>
        <td>{{ prescription.quantity }}</td>
        <td>{{ prescription.prescribed_date|date:"d.m.Y" }}</td>
        <td>
            <!-- Edit tugmasi (modal yoki form) -->
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{ prescription.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            
            <!-- Delete formasi (POST orqali) -->
            <form method="post" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ?');">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="prescription_id" value="{{ prescription.id }}">
                <button type="submit" class="btn btn-sm btn-outline-danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </td>
    </tr>

    <!-- Edit Modal (Bootstrap bilan) -->
    <div class="modal fade" id="editModal{{ prescription.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="prescription_id" value="{{ prescription.id }}">
                        <div class="mb-3">
                            <label class="form-label">–ü–∞—Ü–∏–µ–Ω—Ç:</label>
                            <select name="patient" class="form-select">
                                {% for p in all_patients %}
                                <option value="{{ p.id }}" {% if p.id == prescription.patient.id %}selected{% endif %}>{{ p }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–õ–µ–∫–∞—Ä—Å—Ç–≤–æ:</label>
                            <select name="medicine" class="form-select">
                                {% for m in all_medicines %}
                                <option value="{{ m.id }}" {% if m.id == prescription.medicine.id %}selected{% endif %}>{{ m }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                            <input type="number" name="quantity" value="{{ prescription.quantity }}" min="1" class="form-control">
                        </div>
                        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</tbody>
<!-- ... qolgan kod ... -->                            </table>
                        </div>
                        <!-- Sahifalash, agar kerak bo'lsa -->
                        {% if is_paginated %}
                            <nav aria-label="Pagination">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a></li>
                                    {% endif %}
                                    {% for num in page_obj.paginator.page_range %}
                                        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endfor %}
                                    {% if page_obj.has_next %}
                                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è</a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π –ª–µ–∫–∞—Ä—Å—Ç–≤.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}