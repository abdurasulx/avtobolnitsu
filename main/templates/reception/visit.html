{% extends 'reception/base.html' %}
{% block title %}Визиты{% endblock %}
{% block header %}Визиты{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-semibold text-primary">Список визитов</h4>
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addVisitModal">➕ Новый визит</button>
</div>

<table class="table table-bordered table-striped align-middle">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Пациент</th>
      <th>Доктор</th>
      <th>Дата</th>
      <th>Статус</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody>
    {% for v in visits %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ v.patient }}</td>
      <td>{{ v.doctor }}</td>
      <td>{{ v.visit_datetime|date:"d.m.Y H:i" }}</td>
      <td>{{ v.get_status_display }}</td>
      <td>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editVisitModal{{ v.id }}">✏️</button>
        
      </td>
    </tr>

    <!-- Edit modal -->
    <div class="modal fade" id="editVisitModal{{ v.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="#">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title">Редактировать визит </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <select name="status" class="form-select mb-2">
                <option value="in_progress" {% if v.status == 'in_progress' %}selected{% endif %}>В процессе</option>
                <option value="ended" {% if v.status == 'ended' %}selected{% endif %}>Завершен</option>
              </select>
              <textarea name="diagnosis" class="form-control mb-2" placeholder="Диагноз">{{ v.diagnosis }}</textarea>
              <textarea name="treatment_plan" class="form-control mb-2" placeholder="План лечения">{{ v.treatment_plan }}</textarea>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Сохранить</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </tbody>
</table>

<!-- Add modal -->
<div class="modal fade" id="addVisitModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="#">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Новый визит</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select name="patient" class="form-select mb-2">
            <option value="">Выберите пациента</option>
            {% for p in patients %}
            <option value="{{ p.id }}">{{ p.first_name }} {{ p.last_name }}</option>
            {% endfor %}
          </select>

          <select name="doctor" class="form-select mb-2">
            <option value="">Выберите врача</option>
            {% for d in doctors %}
            <option value="{{ d.id }}">{{ d.user.get_full_name }}</option>
            {% endfor %}
          </select>

          <textarea name="diagnosis" class="form-control mb-2" placeholder="Диагноз"></textarea>
          <textarea name="treatment_plan" class="form-control mb-2" placeholder="План лечения"></textarea>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Добавить</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
